<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico - Treinano</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            color: #f97316;
            margin-bottom: 30px;
            font-size: 28px;
        }
        .section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .section h2 {
            color: #60a5fa;
            font-size: 18px;
            margin-bottom: 15px;
        }
        .item {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 15px;
            border-radius: 8px;
            margin: 8px 0;
            font-size: 14px;
        }
        .success {
            color: #10b981;
        }
        .error {
            color: #ef4444;
        }
        .warning {
            color: #f59e0b;
        }
        button {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.3);
            transition: transform 0.2s;
        }
        button:active {
            transform: scale(0.98);
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #60a5fa;
        }
        code {
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico Completo</h1>

        <div id="loading" class="loading">
            Executando diagn√≥stico...
        </div>

        <div id="results" style="display: none;">
            <div class="section">
                <h2>üåê Navegador</h2>
                <div id="browser-info"></div>
            </div>

            <div class="section">
                <h2>üì± Dispositivo</h2>
                <div id="device-info"></div>
            </div>

            <div class="section">
                <h2>üîß Service Workers</h2>
                <div id="sw-info"></div>
            </div>

            <div class="section">
                <h2>üíæ Cache & Armazenamento</h2>
                <div id="cache-info"></div>
            </div>

            <div class="section">
                <h2>üåç Conex√£o</h2>
                <div id="network-info"></div>
            </div>

            <div class="section">
                <h2>‚ö†Ô∏è Erros Detectados</h2>
                <div id="errors-info"></div>
            </div>
        </div>

        <div style="display: grid; gap: 10px; margin-top: 20px;">
            <button onclick="limparTudo()">üóëÔ∏è Limpar Tudo e Recarregar</button>
            <button onclick="testarApp()">üöÄ Testar App Principal</button>
            <button onclick="copiarLog()">üìã Copiar Diagn√≥stico</button>
        </div>
    </div>

    <script>
        let diagnosticLog = '';

        function addLog(text) {
            diagnosticLog += text + '\n';
        }

        async function runDiagnostics() {
            const results = {
                browser: {},
                device: {},
                serviceWorkers: {},
                cache: {},
                network: {},
                errors: []
            };

            // Browser Info
            results.browser = {
                userAgent: navigator.userAgent,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                platform: navigator.platform
            };

            // Device Info
            results.device = {
                screen: `${window.screen.width}x${window.screen.height}`,
                viewport: `${window.innerWidth}x${window.innerHeight}`,
                pixelRatio: window.devicePixelRatio,
                touchSupport: 'ontouchstart' in window
            };

            // Service Workers
            if ('serviceWorker' in navigator) {
                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    results.serviceWorkers = {
                        supported: true,
                        count: registrations.length,
                        registrations: registrations.map(reg => ({
                            scope: reg.scope,
                            active: !!reg.active,
                            waiting: !!reg.waiting,
                            installing: !!reg.installing
                        }))
                    };
                } catch (e) {
                    results.serviceWorkers.error = e.message;
                }
            } else {
                results.serviceWorkers = { supported: false };
            }

            // Cache
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    results.cache = {
                        supported: true,
                        count: cacheNames.length,
                        names: cacheNames
                    };
                } catch (e) {
                    results.cache.error = e.message;
                }
            } else {
                results.cache = { supported: false };
            }

            // LocalStorage
            try {
                results.cache.localStorage = {
                    count: localStorage.length,
                    size: JSON.stringify(localStorage).length
                };
            } catch (e) {
                results.cache.localStorageError = e.message;
            }

            // Network
            if ('connection' in navigator) {
                const conn = navigator.connection;
                results.network = {
                    effectiveType: conn.effectiveType,
                    downlink: conn.downlink,
                    rtt: conn.rtt,
                    saveData: conn.saveData
                };
            }

            // Display results
            displayResults(results);
        }

        function displayResults(results) {
            // Browser
            const browserDiv = document.getElementById('browser-info');
            browserDiv.innerHTML = `
                <div class="item">User Agent: <code>${results.browser.userAgent}</code></div>
                <div class="item">Idioma: ${results.browser.language}</div>
                <div class="item">Cookies: ${results.browser.cookieEnabled ? '<span class="success">‚úì Habilitados</span>' : '<span class="error">‚úó Desabilitados</span>'}</div>
                <div class="item">Online: ${results.browser.onLine ? '<span class="success">‚úì Sim</span>' : '<span class="error">‚úó N√£o</span>'}</div>
            `;
            addLog('=== NAVEGADOR ===');
            addLog(JSON.stringify(results.browser, null, 2));

            // Device
            const deviceDiv = document.getElementById('device-info');
            deviceDiv.innerHTML = `
                <div class="item">Tela: ${results.device.screen}</div>
                <div class="item">Viewport: ${results.device.viewport}</div>
                <div class="item">Pixel Ratio: ${results.device.pixelRatio}</div>
                <div class="item">Touch: ${results.device.touchSupport ? '<span class="success">‚úì Sim</span>' : '<span class="warning">N√£o</span>'}</div>
            `;
            addLog('\n=== DISPOSITIVO ===');
            addLog(JSON.stringify(results.device, null, 2));

            // Service Workers
            const swDiv = document.getElementById('sw-info');
            if (results.serviceWorkers.supported) {
                let swHtml = `<div class="item">Suporte: <span class="success">‚úì Sim</span></div>`;
                swHtml += `<div class="item">Registros Ativos: ${results.serviceWorkers.count}</div>`;
                if (results.serviceWorkers.registrations.length > 0) {
                    results.serviceWorkers.registrations.forEach((reg, i) => {
                        swHtml += `<div class="item warning">SW ${i+1}: ${reg.scope}</div>`;
                    });
                }
                swDiv.innerHTML = swHtml;
            } else {
                swDiv.innerHTML = '<div class="item error">Service Workers n√£o suportados</div>';
            }
            addLog('\n=== SERVICE WORKERS ===');
            addLog(JSON.stringify(results.serviceWorkers, null, 2));

            // Cache
            const cacheDiv = document.getElementById('cache-info');
            let cacheHtml = '';
            if (results.cache.supported) {
                cacheHtml += `<div class="item">Cache API: <span class="success">‚úì Suportada</span></div>`;
                cacheHtml += `<div class="item">Caches Ativos: ${results.cache.count}</div>`;
                if (results.cache.names.length > 0) {
                    results.cache.names.forEach(name => {
                        cacheHtml += `<div class="item warning">${name}</div>`;
                    });
                }
            }
            if (results.cache.localStorage) {
                cacheHtml += `<div class="item">LocalStorage: ${results.cache.localStorage.count} itens (${Math.round(results.cache.localStorage.size/1024)}KB)</div>`;
            }
            cacheDiv.innerHTML = cacheHtml;
            addLog('\n=== CACHE ===');
            addLog(JSON.stringify(results.cache, null, 2));

            // Network
            const networkDiv = document.getElementById('network-info');
            if (results.network.effectiveType) {
                networkDiv.innerHTML = `
                    <div class="item">Tipo: ${results.network.effectiveType}</div>
                    <div class="item">Downlink: ${results.network.downlink} Mbps</div>
                    <div class="item">RTT: ${results.network.rtt} ms</div>
                    <div class="item">Economia de Dados: ${results.network.saveData ? 'Ativa' : 'Inativa'}</div>
                `;
            } else {
                networkDiv.innerHTML = '<div class="item">Informa√ß√µes de rede n√£o dispon√≠veis</div>';
            }
            addLog('\n=== REDE ===');
            addLog(JSON.stringify(results.network, null, 2));

            // Errors
            const errorsDiv = document.getElementById('errors-info');
            if (results.errors.length > 0) {
                errorsDiv.innerHTML = results.errors.map(err =>
                    `<div class="item error">${err}</div>`
                ).join('');
            } else {
                errorsDiv.innerHTML = '<div class="item success">Nenhum erro detectado at√© agora</div>';
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('results').style.display = 'block';
        }

        async function limparTudo() {
            if (!confirm('Isso vai limpar TODOS os dados do app. Continuar?')) {
                return;
            }

            try {
                // Remove Service Workers
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                        console.log('SW removido:', registration.scope);
                    }
                }

                // Limpa Caches
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    for (let name of cacheNames) {
                        await caches.delete(name);
                        console.log('Cache removido:', name);
                    }
                }

                // Limpa Storage
                localStorage.clear();
                sessionStorage.clear();

                alert('‚úÖ Tudo limpo! Recarregando...');
                window.location.href = '/';
            } catch (e) {
                alert('‚ùå Erro: ' + e.message);
            }
        }

        function testarApp() {
            window.location.href = '/';
        }

        function copiarLog() {
            navigator.clipboard.writeText(diagnosticLog).then(() => {
                alert('‚úÖ Diagn√≥stico copiado para √°rea de transfer√™ncia!');
            }).catch(() => {
                alert('‚ùå Erro ao copiar. Abra o console para ver o log.');
                console.log(diagnosticLog);
            });
        }

        // Capture errors
        window.addEventListener('error', (e) => {
            console.error('Erro:', e);
            addLog('\nERRO: ' + e.message);
        });

        // Run diagnostics on load
        runDiagnostics();
    </script>
</body>
</html>
